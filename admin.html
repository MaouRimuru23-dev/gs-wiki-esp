<!doctype html>
  <html lang="es" data-bs-theme="light">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <title>Admin • GS Wiki</title>

    <!-- Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <!-- Tu CSS (opcional) -->
    <link href="./css/styles.css" rel="stylesheet">

    <style>
      /* Estética suave del admin */
      .app-navbar { backdrop-filter: blur(6px); }
      .app-navbar .navbar-brand { letter-spacing:.5px; font-weight:700; }
      .card { border:0; border-radius: 16px; box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.06); }
      .card-header { background: transparent; border-bottom: 0; }
      .toolbar { gap:.5rem; }
      .list-empty { padding:2rem; color: var(--bs-secondary); text-align: center; }
      .table-sm td, .table-sm th { vertical-align: middle; }
      .avatar-sm {
        width: 40px; height: 40px; border-radius: 8px; object-fit: cover; background:#f1f3f5;
      }
      .badge-tierra { background:#7c8a3e; }   /* por si no la tenías aún */
      .badge-fuego { background:#e8590c; }
      .badge-agua { background:#228be6; }
      .badge-viento { background:#12b886; }
      .badge-luz { background:#fab005; color:#222; }
      .badge-oscuridad { background:#5f3dc4; }
      .sticky-col { position: sticky; top: 88px; }
    </style>
  </head>



  <body>
    <div id="loginBox" class="container mt-5 text-center">
    <h2>Acceso restringido</h2>
    <p>Introduce tus credenciales de administrador</p>
    <input type="text" id="user" class="form-control w-50 mx-auto my-2" placeholder="Usuario">
    <input type="password" id="pass" class="form-control w-50 mx-auto my-2" placeholder="Contraseña">
    <button id="btnLogin" class="btn btn-primary">Entrar</button>
    <p id="loginMsg" class="text-danger mt-2"></p>
  </div>
  <div id="adminPanel" class="d-none">
    <!-- NAV -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom fixed-top app-navbar">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center" href="./">
          <span class="me-2">⚔️</span> GS Wiki • Admin
        </a>
        <div class="ms-auto d-flex align-items-center toolbar">
          <button id="themeBtn" class="btn btn-outline-secondary btn-sm">Tema</button>
          <button id="logoutBtn" class="btn btn-outline-danger btn-sm d-none">Salir</button>
        </div>
      </div>
    </nav>

  <main class="container-fluid" style="padding-top:92px; padding-bottom:32px;">
        <div class="row g-3">
          <!-- Columna izquierda: Lista -->
          <div class="col-lg-5">
            <div class="card sticky-col">
              <div class="card-header">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <h5 class="m-0">Personajes</h5>
                    <small class="text-body-secondary">Busca, edita o elimina</small>
                  </div>
                  <div class="toolbar">
                    <button id="btnNuevo" class="btn btn-primary btn-sm">+ Nuevo</button>
                  </div>
                </div>
              </div>
              <div class="card-body pt-0">
                <div class="mb-3">
                  <input id="adminSearch" class="form-control" placeholder="Buscar por nombre..." />
                </div>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="text-body-secondary">
                      <tr>
                        <th style="width:56px;">Img</th>
                        <th>Nombre</th>
                        <th style="width:90px;">Elemento</th>
                        <th style="width:90px;">Rareza</th>
                        <th class="text-end" style="width:120px;">Acciones</th>
                      </tr>
                    </thead>
                    <tbody id="adminList"><!-- JS pinta filas --></tbody>
                  </table>
                </div>

              <div id="adminEmpty" class="list-empty d-none">
                No hay personajes aún. Crea uno con “+ Nuevo”.
              </div>
            </div>
          </div>
        </div>

        <!-- Columna derecha: Formularios -->
        <div class="col-lg-7">

          <!-- Formulario personaje (IDs compatibles con ui.js) -->
          <div class="card mb-3 d-none" id="formCard">
            <div class="card-header">
              <h5 class="m-0">Ficha de personaje</h5>
            </div>
            <div class="card-body">
              <form id="formPersonaje" class="row g-3">
                <div class="col-md-8">
                  <label class="form-label">Nombre</label>
                  <input id="p_nombre" class="form-control" placeholder="Ej. War Hero Fen">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Slug</label>
                  <input id="p_slug" class="form-control" placeholder="war-hero-fen">
                </div>

                <div class="col-md-4">
                  <label class="form-label">Elemento</label>
                  <select id="p_elemento" class="form-select">
                    <option>Fuego</option><option>Agua</option><option>Tierra</option>
                    <option>Viento</option><option>Luz</option><option>Oscuridad</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Rol</label>
                  <select id="p_rol" class="form-select">
                      <option>DPS</option><option>Tank</option><option>Support</option>
                      <option>Sub DPS</option><option>Healer</option><option>Breaker</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Rareza</label>
                  <select id="p_rareza" class="form-select">
                      <option>Ascend</option><option>Awaken</option><option>5 stars</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Raza</label>
                  <input id="p_raza" class="form-control" placeholder="Ej. Human, 精霊族">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Voz</label>
                  <input id="p_voz" class="form-control" placeholder="Seiyuu / VA">
                </div>
              
                <!-- STATS -->
                <div class="col-12"><hr><h6 class="mb-2">Stats base</h6></div>
                <div class="col-4"><label class="form-label">HP</label><input id="p_hp" type="number" class="form-control" value="0"></div>
                <div class="col-4"><label class="form-label">ATK</label><input id="p_atk" type="number" class="form-control" value="0"></div>
                <div class="col-4"><label class="form-label">DEF</label><input id="p_def" type="number" class="form-control" value="0"></div>
                <div class="col-4"><label class="form-label">+TAS HP</label><input id="p_tas_hp" type="number" class="form-control" value="0"></div>
                <div class="col-4"><label class="form-label">+TAS ATK</label><input id="p_tas_atk" type="number" class="form-control" value="0"></div>
                <div class="col-4"><label class="form-label">+TAS DEF</label><input id="p_tas_def" type="number" class="form-control" value="0"></div>
              
                <!-- SLOTS -->
                <div class="col-12"><hr><h6 class="mb-2">Slots</h6></div>
                <!-- Slot 1 -->
                <div class="col-md-6">
                  <label class="form-label">Slot 1 — Tipo</label>
                  <select id="slot1_tipo" class="form-select">
                    <option>Físico</option><option>Magia</option><option>Defensa</option>
                    <option>Soporte</option><option>Curación</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Slot 1 — Nivel</label>
                  <input id="slot1_nivel" type="number" class="form-control" value="5">
                </div>
                <!-- Slot 2 -->
                <div class="col-md-6">
                  <label class="form-label">Slot 2 — Tipo</label>
                  <select id="slot2_tipo" class="form-select">
                    <option>Físico</option><option>Magia</option><option>Defensa</option>
                    <option>Soporte</option><option>Curación</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Slot 2 — Nivel</label>
                  <input id="slot2_nivel" type="number" class="form-control" value="5">
                </div>
                <!-- Slot 3 (dual para ASND) -->
                <div class="col-md-4">
                  <label class="form-label">Slot 3 — Tipo A</label>
                  <select id="slot3_tipoA" class="form-select">
                    <option>Físico</option><option>Magia</option><option>Defensa</option>
                    <option>Soporte</option><option>Curación</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Slot 3 — Tipo B (opcional)</label>
                  <select id="slot3_tipoB" class="form-select">
                    <option value="">(solo uno)</option>
                    <option>Físico</option><option>Magia</option><option>Defensa</option>
                    <option>Soporte</option><option>Curación</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Slot 3 — Nivel</label>
                  <input id="slot3_nivel" type="number" class="form-control" value="4">
                  <div class="form-text">Si eliges Tipo B, alternará cada 3s (Ascend).</div>
                </div>
              

                <div class="col-12">
                  <label class="form-label">Descripción</label>
                  <textarea id="p_descripcion" rows="3" class="form-control"
                    placeholder="Descripción corta / notas..."></textarea>
                </div>

                <div class="col-md-8">
                  <label class="form-label">Portada (URL de Cloudinary)</label>
                  <input id="p_portada_url" class="form-control" placeholder="https://res.cloudinary.com/tu_cloud/image/upload/.../personajes/fen.webp">
                  <div class="form-text">Pega aquí el enlace público de Cloudinary.</div>
                  <img id="p_portada_prev" class="mt-2 rounded" style="max-height:140px; object-fit:contain; display:none">
                </div>

                <div class="col-md-4 d-grid">
                  <label class="form-label invisible">.</label>
                  <button class="btn btn-primary">Guardar</button>
                </div>
              </form>

              <hr class="my-4">

              <!-- HABILIDADES -->
              <div class="row g-3">
                <div class="col-lg-5">
                  <h6 class="mb-2">Nueva habilidad</h6>
                  <form id="formHabilidad" class="row g-2">
                    <input type="hidden" id="h_id">
                    <div class="col-6">
                      <label class="form-label">Tipo</label>
                      <input id="h_tipo" class="form-control" list="tiposHabs" placeholder="Tipo (ej. Skill, True Arts, Cross Arts, Phantom Bullet, Liberation)">
                      <datalist id="tiposHabs">
                        <option value="Skill">
                        <option value="Arts">
                        <option value="True Arts">
                        <option value="Super Arts">
                        <option value="Passive">
                        <option value="Phantom Bullet">
                        <option value="Cross Arts">
                        <option value="Liberation Skill">
                        <option value="Mega Arts">
                      </datalist>
                    </div>
                    <div class="col-6">
                      <label class="form-label">Orden</label>
                      <input id="h_orden" type="number" class="form-control" value="0">
                    </div>
                    <div class="col-12">
                      <label class="form-label">Nombre</label>
                      <input id="h_nombre" class="form-control" placeholder="Nombre de habilidad">
                    </div>
                    <div class="col-12">
                      <label class="form-label">Descripción</label>
                      <textarea id="h_desc" rows="3" class="form-control"></textarea>
                    </div>
                    <div class="col-12 d-grid">
                      <button class="btn btn-outline-primary">Guardar habilidad</button>
                    </div>
                  </form>
                </div>

                <div class="col-lg-7">
                  <h6 class="mb-2">Habilidades guardadas</h6>
                  <div class="table-responsive">
                    <table class="table table-sm">
                      <thead class="text-body-secondary">
                        <tr>
                          <th>Tipo</th><th>Nombre</th><th>Descripción</th><th>Orden</th><th class="text-end">Acciones</th>
                        </tr>
                      </thead>
                      <tbody id="listHabilidades"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="text-end">
                <small class="text-body-secondary">Slug actual: <span id="adminSlug">—</span></small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal eliminar -->
    <div class="modal fade" id="modalDelete" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title">Eliminar personaje</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ¿Seguro que deseas eliminar <strong id="delName">este personaje</strong>? Esta acción también borrará sus habilidades.
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="btnConfirmDelete">Eliminar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Módulo: inicializa tema + admin (tu ui.js) y añade la lógica del panel izquierdo -->
    <script type="module">
    import { initTheme, initAdmin } from './js/ui.js';
    import {
      listPersonajes,
      getPersonajeBySlug,
      listHabilidades,
      deleteHabilidad,
      TOKEN
    } from './js/api.js';

    // ===== Inicialización UI base =====
    initTheme();
    //initAdmin(); // deja tus flujos existentes (guardar/skills). Si luego prefieres, podemos mover el login solo aquí.

    // ===== Utilidades DOM =====
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // ===== Lado izquierdo: lista con búsqueda y acciones =====
    const q     = $('#adminSearch');
    const tbody = $('#adminList');
    const empty = $('#adminEmpty');

    // Preview cuando pegas el link (optimiza Cloudinary)
    const urlInput = $("#p_portada_url");
    const urlPrev  = $("#p_portada_prev");
    urlInput?.addEventListener("input", ()=>{
      const v = (urlInput.value || "").trim();
      if (!v) { urlPrev.style.display = "none"; return; }
      const optimized = v.includes("/upload/")
        ? v.replace("/upload/", "/upload/f_auto,q_auto/")
        : v;
      urlPrev.src = optimized;
      urlPrev.style.display = "block";
    });

    let state = { page:1, pageSize:999, q:'' };
    let currentDeleteSlug = null;

    async function loadList(){
      const { rows } = await listPersonajes({
        q: state.q, elemento:'', rol:'', order:'nombre', page:1, pageSize:state.pageSize
      });
      renderList(rows);
    }

    function badge(el){
      const key = (el||'').toLowerCase();
      return `<span class="badge badge-${key}">${el||''}</span>`;
    }

    function renderList(rows){
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td><img class="avatar-sm" src="${r.portada_url||''}" alt=""></td>
          <td>
            <div class="fw-semibold">${r.nombre||''}</div>
            <div class="small text-body-secondary">${r.slug}</div>
          </td>
          <td>${badge(r.elemento)}</td>
          <td><span class="badge bg-secondary-subtle text-body">${r.rareza||''}</span></td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" data-act="edit" data-slug="${r.slug}">Editar</button>
              <button class="btn btn-outline-danger" data-act="del" data-slug="${r.slug}" data-name="${r.nombre}">Borrar</button>
            </div>
          </td>
        </tr>
      `).join('');

      empty.classList.toggle('d-none', rows.length>0);

      // wiring acciones
      tbody.querySelectorAll('button').forEach(b=>{
        const act = b.dataset.act, slug = b.dataset.slug;
        if (act === 'edit'){
          b.onclick = ()=> selectForEdit(slug);
        } else if (act === 'del'){
          b.onclick = ()=> openDelete(slug, b.dataset.name);
        }
      });
    }

    async function selectForEdit(slug){
      // Carga datos y llena el formulario de la derecha (IDs que usa tu ui.js)
      const p = await getPersonajeBySlug(slug);
      $('#p_nombre').value        = p.nombre || '';
      $('#p_slug').value          = p.slug || '';
      $('#p_elemento').value      = p.elemento || 'Fuego';
      $('#p_rol').value           = p.rol || '';
      $('#p_rareza').value        = p.rareza || '';
      $('#p_descripcion').value   = p.descripcion || '';
      $('#p_portada_url').value   = p.portada_url || '';
      $('#p_raza').value          = p.raza || '';
      $('#p_voz').value           = p.voz || '';

      const prev = document.getElementById('p_portada_prev');
      if (prev) {
        if (p.portada_url) { prev.src = p.portada_url; prev.style.display = 'block'; }
        else { prev.src = ''; prev.style.display = 'none'; }
      }

      // stats
      const st = p.stats || {};
      $('#p_hp').value      = st.hp || 0;
      $('#p_atk').value     = st.atk || 0;
      $('#p_def').value     = st.def || 0;
      $('#p_tas_hp').value  = st.tas_hp || 0;
      $('#p_tas_atk').value = st.tas_atk || 0;
      $('#p_tas_def').value = st.tas_def || 0;

      // slots
      const sl = p.slots || [];
      if (sl[0]) {
        const t0 = Array.isArray(sl[0].tipo) ? sl[0].tipo[0] : sl[0].tipo;
        $('#slot1_tipo').value  = t0 || 'Físico';
        $('#slot1_nivel').value = sl[0].nivel || 0;
      }
      if (sl[1]) {
        const t1 = Array.isArray(sl[1].tipo) ? sl[1].tipo[0] : sl[1].tipo;
        $('#slot2_tipo').value  = t1 || 'Magia';
        $('#slot2_nivel').value = sl[1].nivel || 0;
      }
      if (sl[2]) {
        const tipos3 = Array.isArray(sl[2].tipo) ? sl[2].tipo : [sl[2].tipo];
        $('#slot3_tipoA').value = tipos3[0] || 'Soporte';
        $('#slot3_tipoB').value = tipos3[1] || '';
        $('#slot3_nivel').value = sl[2].nivel || 0;
      }

      // mostrar form si estaba oculto
      $('#formCard').classList.remove('d-none');

      // Cambia la URL (sin recargar) para que ui.js use el slug en habilidades
      history.replaceState({}, '', `?slug=${encodeURIComponent(slug)}`);
      // Actualiza el slug visible
      $('#adminSlug').textContent = slug;

      // Tabla de habilidades del panel derecho
      await loadHabs(slug);

      // Scroll al form
      document.getElementById('formCard')?.scrollIntoView({ behavior:'smooth', block:'start' });
    }

    // Buscar
    q?.addEventListener('input', ()=>{
      state.q = q.value.trim();
      loadList();
    });

    // Nuevo → limpia form para crear
    $('#btnNuevo')?.addEventListener('click', ()=>{
      $('#p_nombre').value      = '';
      $('#p_slug').value        = '';
      $('#p_elemento').value    = 'Fuego';
      $('#p_rol').value         = '';
      $('#p_rareza').value      = '';
      $('#p_descripcion').value = '';
      $('#p_portada_url').value = '';
      const prev = document.getElementById('p_portada_prev');
      if (prev) { prev.src = ''; prev.style.display = 'none'; }

      $('#formCard').classList.remove('d-none');
      history.replaceState({}, '', location.pathname); // sin slug
      $('#adminSlug').textContent = '—';
      document.getElementById('formCard')?.scrollIntoView({ behavior:'smooth', block:'start' });
    });

    // Eliminar con modal (en Pages solo informamos)
    const modal = new bootstrap.Modal('#modalDelete');
    function openDelete(slug, name){
      currentDeleteSlug = slug;
      $('#delName').textContent = name || slug;
      modal.show();
    }
    $('#btnConfirmDelete')?.addEventListener('click', async ()=>{
      // En GitHub Pages no hay backend: desactivar o simular
      alert('Borrar personaje requiere backend. (En Pages no está disponible)');
      modal.hide();
    });

    // Mostrar form si hay ?slug= al entrar (cuando ya hay sesión)
    function initFromQuery(){
      const slug = new URLSearchParams(location.search).get('slug');
      if (slug){
        selectForEdit(slug).catch(console.error);
      }
    }

    // Sincroniza visibilidad del contenedor card con el form interno de ui.js
    const formCard = document.getElementById('formCard');
    const observer = new MutationObserver(()=>{
      const formVisible = !document.getElementById('formPersonaje')?.classList.contains('d-none');
      formCard?.classList.toggle('d-none', !formVisible);
    });
    observer.observe(document.body, { attributes:true, subtree:true, attributeFilter:['class'] });

    // ===== Habilidades (tabla derecha) =====
    async function loadHabs(slug){
      const habs = await listHabilidades(slug);
      const list = document.getElementById('listHabilidades');
      list.innerHTML = habs.map(h=>`
        <tr>
          <td>${h.tipo||''}</td>
          <td>${h.nombre||''}</td>
          <td>${h.descripcion||''}</td>
          <td>${h.orden||0}</td>
          <td class="text-end">
            ${h.id ? `<button class="btn btn-sm btn-outline-danger" data-id="${h.id}">Borrar</button>`:''}
          </td>
        </tr>`).join('');
      list.querySelectorAll('button[data-id]').forEach(b=>{
        b.onclick = async ()=>{
          await deleteHabilidad(parseInt(b.dataset.id));
          await loadHabs(slug);
        };
      });
    }

    // ===== Validación local (login sin backend) =====
    let adminInited = false;
    const adminUser = "maou";
    const adminPass = "b0xtest"; // cámbialo por algo propio
    const LS_KEY    = "gs_admin_logged";

    const loginBox   = document.getElementById('loginBox');
    const adminPanel = document.getElementById('adminPanel');
    const msg        = document.getElementById('loginMsg');
    const btnLogin   = document.getElementById('btnLogin');
    

    function showPanel() {
      loginBox?.classList.add('d-none');
      adminPanel?.classList.remove('d-none');
      // Ahora que hay sesión, carga lista y valida query
       // Inicializa admin sólo una vez y DESPUÉS del login
      if (!adminInited) {
        initAdmin();
        adminInited = true;
      }
      loadList();
      initFromQuery();
    }
    function logout() {
      localStorage.removeItem(LS_KEY);
      location.reload();
    }

    btnLogin?.addEventListener('click', ()=>{
      const u = document.getElementById('user').value.trim();
      const p = document.getElementById('pass').value.trim();
      if (u === adminUser && p === adminPass) {
        localStorage.setItem(LS_KEY, TOKEN); // guardamos el token
        showPanel();
      } else {
        msg.textContent = "Usuario o contraseña incorrectos.";
      }
    });

    // Autologin: si ya hay token, mostrar y cargar lista
    if (localStorage.getItem(LS_KEY) === TOKEN) {
      showPanel();
    }

    // Cierre automático al cerrar pestaña
    window.addEventListener('beforeunload', () => localStorage.removeItem(LS_KEY));
    // Si la página vuelve desde el Back/Forward Cache, limpia el login
window.addEventListener('pageshow', (ev) => {
  if (ev.persisted) {
    localStorage.removeItem(LS_KEY);
  }
});

  </script>
  </body>
  </div>
  </html>
